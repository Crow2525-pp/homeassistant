---
# ============================================================================
# TIME-BASED HVAC AUTOMATIONS
# ============================================================================
# This file implements per-room climate control based on wake/bed times.
#
# Logic:
# - Gates: manual override off; time-based actions require occupancy home/sleeping
# - Living Room: Comfort at wake/bed when home/sleeping; off when away
# - Bedrooms: Comfort during day (wake to bed), Eco/Boost during night (bed to wake)
# - Night mode determines heat/cool based on season:
#   - Heat mode uses Eco preset (energy-efficient heating)
#   - Cool mode uses Boost preset (aggressive cooling)
#
# Rooms:
# - Living Room: Communal space
# - Master Bedroom: Steph & Phil
# - Otto's Room: Henry & Otto (shared)
# - Lucas's Room: Lucas (formerly Henry's Room/Study)
# ============================================================================

# ============================================================================
# LIVING ROOM - Comfort at wake/bed, off when away
# ============================================================================

- id: living_room_time_based_comfort
  alias: "HVAC - Living Room - Comfort (Home/Sleeping)"
  description: "Set comfort at wake/bed when home or sleeping. Turn on when arriving."
  triggers:
    - trigger: state
      entity_id: input_select.occupancy
      id: occupancy_change
    - trigger: time
      at: input_datetime.wakeup_time_living_room
      id: wake_time
    - trigger: time
      at: input_datetime.bedtime_living_room
      id: bed_time
  conditions:
    # Gate: Manual override must be off
    - condition: state
      entity_id: input_boolean.climate_manual_control_living
      state: "off"
  actions:
    - choose:
        # Occupancy change - just turn on when arriving
        - conditions:
            - condition: template
              value_template: "{{ trigger.id == 'occupancy_change' }}"
            - condition: or
              conditions:
                - condition: state
                  entity_id: input_select.occupancy
                  state: Home
                - condition: state
                  entity_id: input_select.occupancy
                  state: Sleeping
                - condition: state
                  entity_id: input_boolean.guest_mode
                  state: "on"
            - condition: template
              value_template: >
                {{ trigger.from_state is not none
                   and trigger.from_state.state not in ['Home', 'Sleeping'] }}
          sequence:
            - action: climate.turn_on
              target:
                entity_id: climate.living_room_versatile_thermostat

        # Time gates - set comfort and choose heat/cool for the day
        - conditions:
            - condition: template
              value_template: "{{ trigger.id in ['wake_time', 'bed_time'] }}"
            - condition: or
              conditions:
                - condition: state
                  entity_id: input_select.occupancy
                  state: Home
                - condition: state
                  entity_id: input_select.occupancy
                  state: Sleeping
                - condition: state
                  entity_id: input_boolean.guest_mode
                  state: "on"
          sequence:
            - action: climate.set_preset_mode
              target:
                entity_id: climate.living_room_versatile_thermostat
              data:
                preset_mode: comfort
            # Determine heat or cool based on season only (no outside temp)
            - choose:
                # Winter/Autumn - Heat
                - conditions:
                    - condition: or
                      conditions:
                        - condition: state
                          entity_id: input_select.climate_season
                          state: winter
                        - condition: state
                          entity_id: input_select.climate_season
                          state: autumn
                  sequence:
                    - action: climate.set_hvac_mode
                      target:
                        entity_id: climate.living_room_versatile_thermostat
                      data:
                        hvac_mode: heat
                # Summer/Spring - Cool
                - conditions:
                    - condition: or
                      conditions:
                        - condition: state
                          entity_id: input_select.climate_season
                          state: summer
                        - condition: state
                          entity_id: input_select.climate_season
                          state: spring
                  sequence:
                    - action: climate.set_hvac_mode
                      target:
                        entity_id: climate.living_room_versatile_thermostat
                      data:
                        hvac_mode: cool
              # Default - off if no season match
              default:
                - action: climate.set_hvac_mode
                  target:
                    entity_id: climate.living_room_versatile_thermostat
                  data:
                    hvac_mode: "off"
  mode: single

# ============================================================================
# MASTER BEDROOM - Comfort day, Eco/Boost night
# ============================================================================

- id: master_bedroom_time_based_day
  alias: "HVAC - Master Bedroom - Daytime Comfort"
  description: "Set master bedroom to comfort during daytime (wake to bed)."
  triggers:
    - trigger: time
      at: input_datetime.wakeup_time_master_bedroom
      id: wake_time
  conditions:
    # Gate 1: Manual override must be off
    - condition: state
      entity_id: input_boolean.climate_manual_control_master
      state: "off"
    # Gate 2: Occupancy must be Home, Sleeping, or Guest Mode
    - condition: or
      conditions:
        - condition: state
          entity_id: input_select.occupancy
          state: Home
        - condition: state
          entity_id: input_select.occupancy
          state: Sleeping
        - condition: state
          entity_id: input_boolean.guest_mode
          state: "on"
    # Time must be within daytime (wake to bed)
    - condition: template
      value_template: >
        {% set wake = states('input_datetime.wakeup_time_master_bedroom') %}
        {% set bed = states('input_datetime.bedtime_master_bedroom') %}
        {% set now_time = now().strftime('%H:%M:%S') %}
        {{ wake <= now_time < bed }}
  actions:
    # Step 1: Set comfort preset for daytime
    - action: climate.set_preset_mode
      target:
        entity_id: climate.masterbed_versatile_thermostat
      data:
        preset_mode: comfort

    # Step 2: Set initial hvac_mode based on season
    - choose:
        # Winter/Autumn - Start with heating
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: input_select.climate_season
                  state: winter
                - condition: state
                  entity_id: input_select.climate_season
                  state: autumn
          sequence:
            - action: climate.set_hvac_mode
              target:
                entity_id: climate.masterbed_versatile_thermostat
              data:
                hvac_mode: heat

        # Summer/Spring - Start with cooling
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: input_select.climate_season
                  state: summer
                - condition: state
                  entity_id: input_select.climate_season
                  state: spring
          sequence:
            - action: climate.set_hvac_mode
              target:
                entity_id: climate.masterbed_versatile_thermostat
              data:
                hvac_mode: cool

  mode: single

- id: master_bedroom_time_based_night
  alias: "HVAC - Master Bedroom - Nighttime Eco/Boost"
  description: "Set master bedroom to eco (heat) or boost (cool) during nighttime (bed to wake)."
  triggers:
    - trigger: time
      at: input_datetime.bedtime_master_bedroom
      id: bed_time
  conditions:
    # Gate 1: Manual override must be off
    - condition: state
      entity_id: input_boolean.climate_manual_control_master
      state: "off"
    # Gate 2: Occupancy must be Home, Sleeping, or Guest Mode
    - condition: or
      conditions:
        - condition: state
          entity_id: input_select.occupancy
          state: Home
        - condition: state
          entity_id: input_select.occupancy
          state: Sleeping
        - condition: state
          entity_id: input_boolean.guest_mode
          state: "on"
    # Time must be within nighttime (bed to wake, wraps midnight)
    - condition: template
      value_template: >
        {% set wake = states('input_datetime.wakeup_time_master_bedroom') %}
        {% set bed = states('input_datetime.bedtime_master_bedroom') %}
        {% set now_time = now().strftime('%H:%M:%S') %}
        {{ now_time >= bed or now_time < wake }}
  actions:
    # Step 1: Set the correct nighttime preset based on season
    - choose:
        # Winter/Autumn - Use eco preset for energy-efficient heating
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: input_select.climate_season
                  state: winter
                - condition: state
                  entity_id: input_select.climate_season
                  state: autumn
          sequence:
            - action: climate.set_preset_mode
              target:
                entity_id: climate.masterbed_versatile_thermostat
              data:
                preset_mode: eco
            - action: climate.set_hvac_mode
              target:
                entity_id: climate.masterbed_versatile_thermostat
              data:
                hvac_mode: heat

        # Summer/Spring - Use boost preset for aggressive cooling
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: input_select.climate_season
                  state: summer
                - condition: state
                  entity_id: input_select.climate_season
                  state: spring
          sequence:
            - action: climate.set_preset_mode
              target:
                entity_id: climate.masterbed_versatile_thermostat
              data:
                preset_mode: boost
            - action: climate.set_hvac_mode
              target:
                entity_id: climate.masterbed_versatile_thermostat
              data:
                hvac_mode: cool

  mode: single

- id: master_bedroom_away_mode
  alias: "HVAC - Master Bedroom - Occupancy On"
  description: "Turn master bedroom on when arriving to Home/Sleeping or guest mode activates."
  triggers:
    - trigger: state
      entity_id: input_select.occupancy
      to:
        - Home
        - Sleeping
      id: home
    - trigger: state
      entity_id: input_boolean.guest_mode
      to: "on"
      id: guest_mode
  conditions:
    - condition: or
      conditions:
        - condition: template
          value_template: >
            {{ trigger.id == 'home'
               and trigger.from_state is not none
               and trigger.from_state.state not in ['Home', 'Sleeping'] }}
        - condition: template
          value_template: "{{ trigger.id == 'guest_mode' }}"
  actions:
    - action: climate.turn_on
      target:
        entity_id: climate.masterbed_versatile_thermostat
  mode: single

# ============================================================================
# OTTO'S ROOM (Henry & Otto) - Comfort day, Eco/Boost night
# ============================================================================

- id: ottos_room_time_based_day
  alias: "HVAC - Otto's Room - Daytime Comfort"
  description: "Set Otto's room to comfort during daytime (wake to bed)."
  triggers:
    - trigger: time
      at: input_datetime.wakeup_time_ottos_room
      id: wake_time
  conditions:
    # Gate 1: Manual override must be off
    - condition: state
      entity_id: input_boolean.climate_manual_control_otto
      state: "off"
    # Gate 2: Occupancy must be Home, Sleeping, or Guest Mode
    - condition: or
      conditions:
        - condition: state
          entity_id: input_select.occupancy
          state: Home
        - condition: state
          entity_id: input_select.occupancy
          state: Sleeping
        - condition: state
          entity_id: input_boolean.guest_mode
          state: "on"
    # Time must be within daytime (wake to bed)
    - condition: template
      value_template: >
        {% set wake = states('input_datetime.wakeup_time_ottos_room') %}
        {% set bed = states('input_datetime.bedtime_ottos_room') %}
        {% set now_time = now().strftime('%H:%M:%S') %}
        {{ wake <= now_time < bed }}
  actions:
    # Step 1: Set comfort preset for daytime
    - action: climate.set_preset_mode
      target:
        entity_id: climate.otto_s_room
      data:
        preset_mode: comfort

    # Step 2: Set initial hvac_mode based on season
    - choose:
        # Winter/Autumn - Start with heating
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: input_select.climate_season
                  state: winter
                - condition: state
                  entity_id: input_select.climate_season
                  state: autumn
          sequence:
            - action: climate.set_hvac_mode
              target:
                entity_id: climate.otto_s_room
              data:
                hvac_mode: heat

        # Summer/Spring - Start with cooling
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: input_select.climate_season
                  state: summer
                - condition: state
                  entity_id: input_select.climate_season
                  state: spring
          sequence:
            - action: climate.set_hvac_mode
              target:
                entity_id: climate.otto_s_room
              data:
                hvac_mode: cool

  mode: single

- id: ottos_room_time_based_night
  alias: "HVAC - Otto's Room - Nighttime Eco/Boost"
  description: "Set Otto's room to eco (heat) or boost (cool) during nighttime (bed to wake)."
  triggers:
    - trigger: time
      at: input_datetime.bedtime_ottos_room
      id: bed_time
  conditions:
    # Gate 1: Manual override must be off
    - condition: state
      entity_id: input_boolean.climate_manual_control_otto
      state: "off"
    # Gate 2: Occupancy must be Home, Sleeping, or Guest Mode
    - condition: or
      conditions:
        - condition: state
          entity_id: input_select.occupancy
          state: Home
        - condition: state
          entity_id: input_select.occupancy
          state: Sleeping
        - condition: state
          entity_id: input_boolean.guest_mode
          state: "on"
    # Time must be within nighttime (bed to wake, wraps midnight)
    - condition: template
      value_template: >
        {% set wake = states('input_datetime.wakeup_time_ottos_room') %}
        {% set bed = states('input_datetime.bedtime_ottos_room') %}
        {% set now_time = now().strftime('%H:%M:%S') %}
        {{ now_time >= bed or now_time < wake }}
  actions:
    # Step 1: Set the correct nighttime preset based on season
    - choose:
        # Winter/Autumn - Use eco preset for energy-efficient heating
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: input_select.climate_season
                  state: winter
                - condition: state
                  entity_id: input_select.climate_season
                  state: autumn
          sequence:
            - action: climate.set_preset_mode
              target:
                entity_id: climate.otto_s_room
              data:
                preset_mode: eco
            - action: climate.set_hvac_mode
              target:
                entity_id: climate.otto_s_room
              data:
                hvac_mode: heat

        # Summer/Spring - Use boost preset for aggressive cooling
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: input_select.climate_season
                  state: summer
                - condition: state
                  entity_id: input_select.climate_season
                  state: spring
          sequence:
            - action: climate.set_preset_mode
              target:
                entity_id: climate.otto_s_room
              data:
                preset_mode: boost
            - action: climate.set_hvac_mode
              target:
                entity_id: climate.otto_s_room
              data:
                hvac_mode: cool

  mode: single

- id: ottos_room_away_mode
  alias: "HVAC - Otto's Room - Occupancy On"
  description: "Turn Otto's room on when arriving to Home/Sleeping or guest mode activates."
  triggers:
    - trigger: state
      entity_id: input_select.occupancy
      to:
        - Home
        - Sleeping
      id: home
    - trigger: state
      entity_id: input_boolean.guest_mode
      to: "on"
      id: guest_mode
  conditions:
    - condition: or
      conditions:
        - condition: template
          value_template: >
            {{ trigger.id == 'home'
               and trigger.from_state is not none
               and trigger.from_state.state not in ['Home', 'Sleeping'] }}
        - condition: template
          value_template: "{{ trigger.id == 'guest_mode' }}"
  actions:
    - action: climate.turn_on
      target:
        entity_id: climate.otto_s_room
  mode: single

# ============================================================================
# LUCAS'S ROOM (formerly Study/Henry's Room) - Comfort day, Eco/Boost night
# ============================================================================

- id: lucas_room_time_based_day
  alias: "HVAC - Lucas's Room - Daytime Comfort"
  description: "Set Lucas's room to comfort during daytime (wake to bed)."
  triggers:
    - trigger: time
      at: input_datetime.wakeup_time_lucas_room
      id: wake_time
  conditions:
    # Gate 1: Manual override must be off
    - condition: state
      entity_id: input_boolean.climate_manual_control_study
      state: "off"
    # Gate 2: Occupancy must be Home, Sleeping, or Guest Mode
    - condition: or
      conditions:
        - condition: state
          entity_id: input_select.occupancy
          state: Home
        - condition: state
          entity_id: input_select.occupancy
          state: Sleeping
        - condition: state
          entity_id: input_boolean.guest_mode
          state: "on"
    # Time must be within daytime (wake to bed)
    - condition: template
      value_template: >
        {% set wake = states('input_datetime.wakeup_time_lucas_room') %}
        {% set bed = states('input_datetime.bedtime_lucas_room') %}
        {% set now_time = now().strftime('%H:%M:%S') %}
        {{ wake <= now_time < bed }}
  actions:
    # Step 1: Set comfort preset for daytime
    - action: climate.set_preset_mode
      target:
        entity_id: climate.henry_s_room_versatile_thermostat
      data:
        preset_mode: comfort

    # Step 2: Set initial hvac_mode based on season
    - choose:
        # Winter/Autumn - Start with heating
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: input_select.climate_season
                  state: winter
                - condition: state
                  entity_id: input_select.climate_season
                  state: autumn
          sequence:
            - action: climate.set_hvac_mode
              target:
                entity_id: climate.henry_s_room_versatile_thermostat
              data:
                hvac_mode: heat

        # Summer/Spring - Start with cooling
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: input_select.climate_season
                  state: summer
                - condition: state
                  entity_id: input_select.climate_season
                  state: spring
          sequence:
            - action: climate.set_hvac_mode
              target:
                entity_id: climate.henry_s_room_versatile_thermostat
              data:
                hvac_mode: cool

  mode: single

- id: lucas_room_time_based_night
  alias: "HVAC - Lucas's Room - Nighttime Eco/Boost"
  description: "Set Lucas's room to eco (heat) or boost (cool) during nighttime (bed to wake)."
  triggers:
    - trigger: time
      at: input_datetime.bedtime_lucas_room
      id: bed_time
  conditions:
    # Gate 1: Manual override must be off
    - condition: state
      entity_id: input_boolean.climate_manual_control_study
      state: "off"
    # Gate 2: Occupancy must be Home, Sleeping, or Guest Mode
    - condition: or
      conditions:
        - condition: state
          entity_id: input_select.occupancy
          state: Home
        - condition: state
          entity_id: input_select.occupancy
          state: Sleeping
        - condition: state
          entity_id: input_boolean.guest_mode
          state: "on"
    # Time must be within nighttime (bed to wake, wraps midnight)
    - condition: template
      value_template: >
        {% set wake = states('input_datetime.wakeup_time_lucas_room') %}
        {% set bed = states('input_datetime.bedtime_lucas_room') %}
        {% set now_time = now().strftime('%H:%M:%S') %}
        {{ now_time >= bed or now_time < wake }}
  actions:
    # Step 1: Set the correct nighttime preset based on season
    - choose:
        # Winter/Autumn - Use eco preset for energy-efficient heating
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: input_select.climate_season
                  state: winter
                - condition: state
                  entity_id: input_select.climate_season
                  state: autumn
          sequence:
            - action: climate.set_preset_mode
              target:
                entity_id: climate.henry_s_room_versatile_thermostat
              data:
                preset_mode: eco
            - action: climate.set_hvac_mode
              target:
                entity_id: climate.henry_s_room_versatile_thermostat
              data:
                hvac_mode: heat

        # Summer/Spring - Use boost preset for aggressive cooling
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: input_select.climate_season
                  state: summer
                - condition: state
                  entity_id: input_select.climate_season
                  state: spring
          sequence:
            - action: climate.set_preset_mode
              target:
                entity_id: climate.henry_s_room_versatile_thermostat
              data:
                preset_mode: boost
            - action: climate.set_hvac_mode
              target:
                entity_id: climate.henry_s_room_versatile_thermostat
              data:
                hvac_mode: cool

  mode: single

- id: lucas_room_away_mode
  alias: "HVAC - Lucas's Room - Occupancy On"
  description: "Turn Lucas's room on when arriving to Home/Sleeping or guest mode activates."
  triggers:
    - trigger: state
      entity_id: input_select.occupancy
      to:
        - Home
        - Sleeping
      id: home
    - trigger: state
      entity_id: input_boolean.guest_mode
      to: "on"
      id: guest_mode
  conditions:
    - condition: or
      conditions:
        - condition: template
          value_template: >
            {{ trigger.id == 'home'
               and trigger.from_state is not none
               and trigger.from_state.state not in ['Home', 'Sleeping'] }}
        - condition: template
          value_template: "{{ trigger.id == 'guest_mode' }}"
  actions:
    - action: climate.turn_on
      target:
        entity_id: climate.henry_s_room_versatile_thermostat
  mode: single
