---
# ============================================================================
# TIME-BASED HVAC AUTOMATIONS
# ============================================================================
# This file implements per-room climate control based on wake/bed times.
#
# Logic:
# - Gates (always checked): manual override off, occupancy home/sleeping
# - Living Room: Always comfort when home/sleeping, eco when away
# - Bedrooms: Comfort during day (wake to bed), Eco/Boost during night (bed to wake)
# - Night mode determines heat/cool based on season and temp delta:
#   - Heat mode uses Frost preset (minimum temperature protection)
#   - Cool mode uses Boost preset (aggressive cooling)
#
# Rooms:
# - Living Room: Communal space
# - Master Bedroom: Steph & Phil
# - Otto's Room: Henry & Otto (shared)
# - Lucas's Room: Lucas (formerly Henry's Room/Study)
# ============================================================================

# ============================================================================
# LIVING ROOM - Always comfort when home/sleeping
# ============================================================================

- id: living_room_time_based_comfort
  alias: "HVAC - Living Room - Comfort (Home/Sleeping)"
  description: "Set living room to comfort when home or sleeping. Eco when away."
  triggers:
    - trigger: state
      entity_id: input_select.occupancy
      id: occupancy_change
    - trigger: time
      at: input_datetime.wakeup_time_living_room
      id: wake_time
    - trigger: time
      at: input_datetime.bedtime_living_room
      id: bed_time
    - trigger: state
      entity_id: input_boolean.climate_manual_control_living
      to: "off"
      id: manual_override_cleared
    - trigger: homeassistant
      event: start
      id: ha_start
    - trigger: state
      entity_id: climate.living_room_versatile_thermostat
      attribute: current_temperature
      id: climate_current_temp_change
    - trigger: state
      entity_id: climate.living_room_versatile_thermostat
      attribute: temperature
      id: climate_target_temp_change
  conditions:
    # Gate: Manual override must be off
    - condition: state
      entity_id: input_boolean.climate_manual_control_living
      state: "off"
  actions:
    - choose:
        # Away or Holiday - Set to eco and turn off
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: input_select.occupancy
                  state: Away
                - condition: state
                  entity_id: input_select.occupancy
                  state: Holiday
          sequence:
            - action: climate.set_preset_mode
              target:
                entity_id: climate.living_room_versatile_thermostat
              data:
                preset_mode: eco
            - action: climate.set_hvac_mode
              target:
                entity_id: climate.living_room_versatile_thermostat
              data:
                hvac_mode: "off"
        # Home or Sleeping - Set to comfort with appropriate heat/cool
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: input_select.occupancy
                  state: Home
                - condition: state
                  entity_id: input_select.occupancy
                  state: Sleeping
          sequence:
            - action: climate.set_preset_mode
              target:
                entity_id: climate.living_room_versatile_thermostat
              data:
                preset_mode: comfort
            # Determine heat or cool based on season only (no outside temp)
            - choose:
                # Winter/Autumn - Heat
                - conditions:
                    - condition: or
                      conditions:
                        - condition: state
                          entity_id: input_select.climate_season
                          state: winter
                        - condition: state
                          entity_id: input_select.climate_season
                          state: autumn
                  sequence:
                    - action: climate.set_hvac_mode
                      target:
                        entity_id: climate.living_room_versatile_thermostat
                      data:
                        hvac_mode: heat
                # Summer/Spring - Cool
                - conditions:
                    - condition: or
                      conditions:
                        - condition: state
                          entity_id: input_select.climate_season
                          state: summer
                        - condition: state
                          entity_id: input_select.climate_season
                          state: spring
                  sequence:
                    - action: climate.set_hvac_mode
                      target:
                        entity_id: climate.living_room_versatile_thermostat
                      data:
                        hvac_mode: cool
              # Default - off if no season match
              default:
                - action: climate.set_hvac_mode
                  target:
                    entity_id: climate.living_room_versatile_thermostat
                  data:
                    hvac_mode: "off"
  mode: single

# ============================================================================
# MASTER BEDROOM - Comfort day, Eco/Boost night
# ============================================================================

- id: master_bedroom_time_based_day
  alias: "HVAC - Master Bedroom - Daytime Comfort"
  description: "Set master bedroom to comfort during daytime (wake to bed)."
  triggers:
    - trigger: time
      at: input_datetime.wakeup_time_master_bedroom
      id: wake_time
    - trigger: state
      entity_id: input_select.occupancy
      to: Home
      id: arrived_home
    - trigger: state
      entity_id: input_boolean.climate_manual_control_master
      to: "off"
      id: manual_override_cleared
    - trigger: state
      entity_id: climate.masterbed_versatile_thermostat
      attribute: current_temperature
      id: climate_current_temp_change
    - trigger: state
      entity_id: climate.masterbed_versatile_thermostat
      attribute: temperature
      id: climate_target_temp_change
  conditions:
    # Gate 1: Manual override must be off
    - condition: state
      entity_id: input_boolean.climate_manual_control_master
      state: "off"
    # Gate 2: Occupancy must be Home or Sleeping
    - condition: or
      conditions:
        - condition: state
          entity_id: input_select.occupancy
          state: Home
        - condition: state
          entity_id: input_select.occupancy
          state: Sleeping
    # Time must be within daytime (wake to bed)
    - condition: template
      value_template: >
        {% set wake = states('input_datetime.wakeup_time_master_bedroom') %}
        {% set bed = states('input_datetime.bedtime_master_bedroom') %}
        {% set now_time = now().strftime('%H:%M:%S') %}
        {{ wake <= now_time < bed }}
  actions:
    # Step 1: Set comfort preset for daytime
    - action: climate.set_preset_mode
      target:
        entity_id: climate.masterbed_versatile_thermostat
      data:
        preset_mode: comfort

    # Step 2: Set initial hvac_mode based on season
    - choose:
        # Winter/Autumn - Start with heating
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: input_select.climate_season
                  state: winter
                - condition: state
                  entity_id: input_select.climate_season
                  state: autumn
          sequence:
            - action: climate.set_hvac_mode
              target:
                entity_id: climate.masterbed_versatile_thermostat
              data:
                hvac_mode: heat

        # Summer/Spring - Start with cooling
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: input_select.climate_season
                  state: summer
                - condition: state
                  entity_id: input_select.climate_season
                  state: spring
          sequence:
            - action: climate.set_hvac_mode
              target:
                entity_id: climate.masterbed_versatile_thermostat
              data:
                hvac_mode: cool

    # Step 3: Wait for comfort preset to apply and target temp to update
    - delay:
        seconds: 2

    # Step 4: Calculate drift and slope from the comfort preset's target
    - variables:
        specific_states: "{{ state_attr('climate.masterbed_versatile_thermostat', 'specific_states') or {} }}"
        current_temp: "{{ state_attr('climate.masterbed_versatile_thermostat', 'current_temperature') | float(none) }}"
        target_temp: "{{ state_attr('climate.masterbed_versatile_thermostat', 'temperature') | float(none) }}"
        preset_mode: "{{ state_attr('climate.masterbed_versatile_thermostat', 'preset_mode') }}"
        hvac_mode: "{{ states('climate.masterbed_versatile_thermostat') }}"
        slope: "{{ specific_states.temperature_slope | float(none) }}"
        drift: >
          {{ current_temp - target_temp if current_temp is not none and target_temp is not none else none }}

    # Step 5: Check overshoot using slope and drift (preserve comfort preset)
    - choose:
        # Overcooled while cooling: falling slope + drift <= -2°C -> switch to heat
        - conditions:
            - condition: template
              value_template: >
                {{ preset_mode is not none and preset_mode != 'none'
                   and hvac_mode == 'cool'
                   and slope is not none and slope < 0
                   and drift is not none and drift <= -2 }}
          sequence:
            - action: climate.set_hvac_mode
              target:
                entity_id: climate.masterbed_versatile_thermostat
              data:
                hvac_mode: heat

        # Overheated while heating: rising slope + drift >= +2°C -> switch to cool
        - conditions:
            - condition: template
              value_template: >
                {{ preset_mode is not none and preset_mode != 'none'
                   and hvac_mode == 'heat'
                   and slope is not none and slope > 0
                   and drift is not none and drift >= 2 }}
          sequence:
            - action: climate.set_hvac_mode
              target:
                entity_id: climate.masterbed_versatile_thermostat
              data:
                hvac_mode: cool
  mode: single

- id: master_bedroom_time_based_night
  alias: "HVAC - Master Bedroom - Nighttime Eco/Boost"
  description: "Set master bedroom to eco (heat) or boost (cool) during nighttime (bed to wake)."
  triggers:
    - trigger: time
      at: input_datetime.bedtime_master_bedroom
      id: bed_time
    - trigger: state
      entity_id: input_select.occupancy
      to: Sleeping
      id: going_to_sleep
    - trigger: state
      entity_id: input_boolean.climate_manual_control_master
      to: "off"
      id: manual_override_cleared
    - trigger: state
      entity_id: climate.masterbed_versatile_thermostat
      attribute: current_temperature
      id: climate_current_temp_change
    - trigger: state
      entity_id: climate.masterbed_versatile_thermostat
      attribute: temperature
      id: climate_target_temp_change
  conditions:
    # Gate 1: Manual override must be off
    - condition: state
      entity_id: input_boolean.climate_manual_control_master
      state: "off"
    # Gate 2: Occupancy must be Home or Sleeping
    - condition: or
      conditions:
        - condition: state
          entity_id: input_select.occupancy
          state: Home
        - condition: state
          entity_id: input_select.occupancy
          state: Sleeping
    # Time must be within nighttime (bed to wake, wraps midnight)
    - condition: template
      value_template: >
        {% set wake = states('input_datetime.wakeup_time_master_bedroom') %}
        {% set bed = states('input_datetime.bedtime_master_bedroom') %}
        {% set now_time = now().strftime('%H:%M:%S') %}
        {{ now_time >= bed or now_time < wake }}
  actions:
    # Step 1: Set the correct nighttime preset based on season
    - choose:
        # Winter/Autumn - Use eco preset for energy-efficient heating
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: input_select.climate_season
                  state: winter
                - condition: state
                  entity_id: input_select.climate_season
                  state: autumn
          sequence:
            - action: climate.set_preset_mode
              target:
                entity_id: climate.masterbed_versatile_thermostat
              data:
                preset_mode: eco
            - action: climate.set_hvac_mode
              target:
                entity_id: climate.masterbed_versatile_thermostat
              data:
                hvac_mode: heat

        # Summer/Spring - Use boost preset for aggressive cooling
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: input_select.climate_season
                  state: summer
                - condition: state
                  entity_id: input_select.climate_season
                  state: spring
          sequence:
            - action: climate.set_preset_mode
              target:
                entity_id: climate.masterbed_versatile_thermostat
              data:
                preset_mode: boost
            - action: climate.set_hvac_mode
              target:
                entity_id: climate.masterbed_versatile_thermostat
              data:
                hvac_mode: cool

    # Step 2: Wait briefly for preset to apply and target temp to update
    - delay:
        seconds: 2

    # Step 3: Calculate drift and slope from the nighttime preset's target
    - variables:
        specific_states: "{{ state_attr('climate.masterbed_versatile_thermostat', 'specific_states') or {} }}"
        current_temp: "{{ state_attr('climate.masterbed_versatile_thermostat', 'current_temperature') | float(none) }}"
        target_temp: "{{ state_attr('climate.masterbed_versatile_thermostat', 'temperature') | float(none) }}"
        preset_mode: "{{ state_attr('climate.masterbed_versatile_thermostat', 'preset_mode') }}"
        hvac_mode: "{{ states('climate.masterbed_versatile_thermostat') }}"
        slope: "{{ specific_states.temperature_slope | float(none) }}"
        drift: >
          {{ current_temp - target_temp if current_temp is not none and target_temp is not none else none }}

    # Step 4: Check overshoot using slope and drift (preserve preset)
    - choose:
        # Overcooled while cooling: falling slope + drift <= -2°C -> switch to heat
        - conditions:
            - condition: template
              value_template: >
                {{ preset_mode is not none and preset_mode != 'none'
                   and hvac_mode == 'cool'
                   and slope is not none and slope < 0
                   and drift is not none and drift <= -2 }}
          sequence:
            - action: climate.set_hvac_mode
              target:
                entity_id: climate.masterbed_versatile_thermostat
              data:
                hvac_mode: heat

        # Overheated while heating: rising slope + drift >= +2°C -> switch to cool
        - conditions:
            - condition: template
              value_template: >
                {{ preset_mode is not none and preset_mode != 'none'
                   and hvac_mode == 'heat'
                   and slope is not none and slope > 0
                   and drift is not none and drift >= 2 }}
          sequence:
            - action: climate.set_hvac_mode
              target:
                entity_id: climate.masterbed_versatile_thermostat
              data:
                hvac_mode: cool
  mode: single

- id: master_bedroom_away_mode
  alias: "HVAC - Master Bedroom - Away Mode"
  description: "Set master bedroom to eco when away."
  triggers:
    - trigger: state
      entity_id: input_select.occupancy
      to:
        - Away
        - Holiday
      id: away
  conditions: []
  actions:
    - action: climate.set_preset_mode
      target:
        entity_id: climate.masterbed_versatile_thermostat
      data:
        preset_mode: eco
    - action: climate.set_hvac_mode
      target:
        entity_id: climate.masterbed_versatile_thermostat
      data:
        hvac_mode: "off"
  mode: single

# ============================================================================
# OTTO'S ROOM (Henry & Otto) - Comfort day, Eco/Boost night
# ============================================================================

- id: ottos_room_time_based_day
  alias: "HVAC - Otto's Room - Daytime Comfort"
  description: "Set Otto's room to comfort during daytime (wake to bed)."
  triggers:
    - trigger: time
      at: input_datetime.wakeup_time_ottos_room
      id: wake_time
    - trigger: state
      entity_id: input_select.occupancy
      to: Home
      id: arrived_home
    - trigger: state
      entity_id: input_boolean.climate_manual_control_otto
      to: "off"
      id: manual_override_cleared
    - trigger: state
      entity_id: climate.otto_s_room
      attribute: current_temperature
      id: climate_current_temp_change
    - trigger: state
      entity_id: climate.otto_s_room
      attribute: temperature
      id: climate_target_temp_change
  conditions:
    # Gate 1: Manual override must be off
    - condition: state
      entity_id: input_boolean.climate_manual_control_otto
      state: "off"
    # Gate 2: Occupancy must be Home or Sleeping
    - condition: or
      conditions:
        - condition: state
          entity_id: input_select.occupancy
          state: Home
        - condition: state
          entity_id: input_select.occupancy
          state: Sleeping
    # Time must be within daytime (wake to bed)
    - condition: template
      value_template: >
        {% set wake = states('input_datetime.wakeup_time_ottos_room') %}
        {% set bed = states('input_datetime.bedtime_ottos_room') %}
        {% set now_time = now().strftime('%H:%M:%S') %}
        {{ wake <= now_time < bed }}
  actions:
    # Step 1: Set comfort preset for daytime
    - action: climate.set_preset_mode
      target:
        entity_id: climate.otto_s_room
      data:
        preset_mode: comfort

    # Step 2: Set initial hvac_mode based on season
    - choose:
        # Winter/Autumn - Start with heating
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: input_select.climate_season
                  state: winter
                - condition: state
                  entity_id: input_select.climate_season
                  state: autumn
          sequence:
            - action: climate.set_hvac_mode
              target:
                entity_id: climate.otto_s_room
              data:
                hvac_mode: heat

        # Summer/Spring - Start with cooling
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: input_select.climate_season
                  state: summer
                - condition: state
                  entity_id: input_select.climate_season
                  state: spring
          sequence:
            - action: climate.set_hvac_mode
              target:
                entity_id: climate.otto_s_room
              data:
                hvac_mode: cool

    # Step 3: Wait for comfort preset to apply and target temp to update
    - delay:
        seconds: 2

    # Step 4: Calculate drift and slope from the comfort preset's target
    - variables:
        specific_states: "{{ state_attr('climate.otto_s_room', 'specific_states') or {} }}"
        current_temp: "{{ state_attr('climate.otto_s_room', 'current_temperature') | float(none) }}"
        target_temp: "{{ state_attr('climate.otto_s_room', 'temperature') | float(none) }}"
        preset_mode: "{{ state_attr('climate.otto_s_room', 'preset_mode') }}"
        hvac_mode: "{{ states('climate.otto_s_room') }}"
        slope: "{{ specific_states.temperature_slope | float(none) }}"
        drift: >
          {{ current_temp - target_temp if current_temp is not none and target_temp is not none else none }}

    # Step 5: Check overshoot using slope and drift (preserve comfort preset)
    - choose:
        # Overcooled while cooling: falling slope + drift <= -2°C -> switch to heat
        - conditions:
            - condition: template
              value_template: >
                {{ preset_mode is not none and preset_mode != 'none'
                   and hvac_mode == 'cool'
                   and slope is not none and slope < 0
                   and drift is not none and drift <= -2 }}
          sequence:
            - action: climate.set_hvac_mode
              target:
                entity_id: climate.otto_s_room
              data:
                hvac_mode: heat

        # Overheated while heating: rising slope + drift >= +2°C -> switch to cool
        - conditions:
            - condition: template
              value_template: >
                {{ preset_mode is not none and preset_mode != 'none'
                   and hvac_mode == 'heat'
                   and slope is not none and slope > 0
                   and drift is not none and drift >= 2 }}
          sequence:
            - action: climate.set_hvac_mode
              target:
                entity_id: climate.otto_s_room
              data:
                hvac_mode: cool
  mode: single

- id: ottos_room_time_based_night
  alias: "HVAC - Otto's Room - Nighttime Eco/Boost"
  description: "Set Otto's room to eco (heat) or boost (cool) during nighttime (bed to wake)."
  triggers:
    - trigger: time
      at: input_datetime.bedtime_ottos_room
      id: bed_time
    - trigger: state
      entity_id: input_select.occupancy
      to: Sleeping
      id: going_to_sleep
    - trigger: state
      entity_id: input_boolean.climate_manual_control_otto
      to: "off"
      id: manual_override_cleared
    - trigger: state
      entity_id: climate.otto_s_room
      attribute: current_temperature
      id: climate_current_temp_change
    - trigger: state
      entity_id: climate.otto_s_room
      attribute: temperature
      id: climate_target_temp_change
  conditions:
    # Gate 1: Manual override must be off
    - condition: state
      entity_id: input_boolean.climate_manual_control_otto
      state: "off"
    # Gate 2: Occupancy must be Home or Sleeping
    - condition: or
      conditions:
        - condition: state
          entity_id: input_select.occupancy
          state: Home
        - condition: state
          entity_id: input_select.occupancy
          state: Sleeping
    # Time must be within nighttime (bed to wake, wraps midnight)
    - condition: template
      value_template: >
        {% set wake = states('input_datetime.wakeup_time_ottos_room') %}
        {% set bed = states('input_datetime.bedtime_ottos_room') %}
        {% set now_time = now().strftime('%H:%M:%S') %}
        {{ now_time >= bed or now_time < wake }}
  actions:
    # Step 1: Set the correct nighttime preset based on season
    - choose:
        # Winter/Autumn - Use eco preset for energy-efficient heating
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: input_select.climate_season
                  state: winter
                - condition: state
                  entity_id: input_select.climate_season
                  state: autumn
          sequence:
            - action: climate.set_preset_mode
              target:
                entity_id: climate.otto_s_room
              data:
                preset_mode: eco
            - action: climate.set_hvac_mode
              target:
                entity_id: climate.otto_s_room
              data:
                hvac_mode: heat

        # Summer/Spring - Use boost preset for aggressive cooling
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: input_select.climate_season
                  state: summer
                - condition: state
                  entity_id: input_select.climate_season
                  state: spring
          sequence:
            - action: climate.set_preset_mode
              target:
                entity_id: climate.otto_s_room
              data:
                preset_mode: boost
            - action: climate.set_hvac_mode
              target:
                entity_id: climate.otto_s_room
              data:
                hvac_mode: cool

    # Step 2: Wait briefly for preset to apply and target temp to update
    - delay:
        seconds: 2

    # Step 3: Calculate drift and slope from the nighttime preset's target
    - variables:
        specific_states: "{{ state_attr('climate.otto_s_room', 'specific_states') or {} }}"
        current_temp: "{{ state_attr('climate.otto_s_room', 'current_temperature') | float(none) }}"
        target_temp: "{{ state_attr('climate.otto_s_room', 'temperature') | float(none) }}"
        preset_mode: "{{ state_attr('climate.otto_s_room', 'preset_mode') }}"
        hvac_mode: "{{ states('climate.otto_s_room') }}"
        slope: "{{ specific_states.temperature_slope | float(none) }}"
        drift: >
          {{ current_temp - target_temp if current_temp is not none and target_temp is not none else none }}

    # Step 4: Check overshoot using slope and drift (preserve preset)
    - choose:
        # Overcooled while cooling: falling slope + drift <= -2°C -> switch to heat
        - conditions:
            - condition: template
              value_template: >
                {{ preset_mode is not none and preset_mode != 'none'
                   and hvac_mode == 'cool'
                   and slope is not none and slope < 0
                   and drift is not none and drift <= -2 }}
          sequence:
            - action: climate.set_hvac_mode
              target:
                entity_id: climate.otto_s_room
              data:
                hvac_mode: heat

        # Overheated while heating: rising slope + drift >= +2°C -> switch to cool
        - conditions:
            - condition: template
              value_template: >
                {{ preset_mode is not none and preset_mode != 'none'
                   and hvac_mode == 'heat'
                   and slope is not none and slope > 0
                   and drift is not none and drift >= 2 }}
          sequence:
            - action: climate.set_hvac_mode
              target:
                entity_id: climate.otto_s_room
              data:
                hvac_mode: cool
  mode: single

- id: ottos_room_away_mode
  alias: "HVAC - Otto's Room - Away Mode"
  description: "Set Otto's room to eco when away."
  triggers:
    - trigger: state
      entity_id: input_select.occupancy
      to:
        - Away
        - Holiday
      id: away
  conditions: []
  actions:
    - action: climate.set_preset_mode
      target:
        entity_id: climate.otto_s_room
      data:
        preset_mode: eco
    - action: climate.set_hvac_mode
      target:
        entity_id: climate.otto_s_room
      data:
        hvac_mode: "off"
  mode: single

# ============================================================================
# LUCAS'S ROOM (formerly Study/Henry's Room) - Comfort day, Eco/Boost night
# ============================================================================

- id: lucas_room_time_based_day
  alias: "HVAC - Lucas's Room - Daytime Comfort"
  description: "Set Lucas's room to comfort during daytime (wake to bed)."
  triggers:
    - trigger: time
      at: input_datetime.wakeup_time_lucas_room
      id: wake_time
    - trigger: state
      entity_id: input_select.occupancy
      to: Home
      id: arrived_home
    - trigger: state
      entity_id: input_boolean.climate_manual_control_study
      to: "off"
      id: manual_override_cleared
    - trigger: state
      entity_id: climate.henry_s_room_versatile_thermostat
      attribute: current_temperature
      id: climate_current_temp_change
    - trigger: state
      entity_id: climate.henry_s_room_versatile_thermostat
      attribute: temperature
      id: climate_target_temp_change
  conditions:
    # Gate 1: Manual override must be off
    - condition: state
      entity_id: input_boolean.climate_manual_control_study
      state: "off"
    # Gate 2: Occupancy must be Home or Sleeping
    - condition: or
      conditions:
        - condition: state
          entity_id: input_select.occupancy
          state: Home
        - condition: state
          entity_id: input_select.occupancy
          state: Sleeping
    # Time must be within daytime (wake to bed)
    - condition: template
      value_template: >
        {% set wake = states('input_datetime.wakeup_time_lucas_room') %}
        {% set bed = states('input_datetime.bedtime_lucas_room') %}
        {% set now_time = now().strftime('%H:%M:%S') %}
        {{ wake <= now_time < bed }}
  actions:
    # Step 1: Set comfort preset for daytime
    - action: climate.set_preset_mode
      target:
        entity_id: climate.henry_s_room_versatile_thermostat
      data:
        preset_mode: comfort

    # Step 2: Set initial hvac_mode based on season
    - choose:
        # Winter/Autumn - Start with heating
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: input_select.climate_season
                  state: winter
                - condition: state
                  entity_id: input_select.climate_season
                  state: autumn
          sequence:
            - action: climate.set_hvac_mode
              target:
                entity_id: climate.henry_s_room_versatile_thermostat
              data:
                hvac_mode: heat

        # Summer/Spring - Start with cooling
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: input_select.climate_season
                  state: summer
                - condition: state
                  entity_id: input_select.climate_season
                  state: spring
          sequence:
            - action: climate.set_hvac_mode
              target:
                entity_id: climate.henry_s_room_versatile_thermostat
              data:
                hvac_mode: cool

    # Step 3: Wait for comfort preset to apply and target temp to update
    - delay:
        seconds: 2

    # Step 4: Calculate drift and slope from the comfort preset's target
    - variables:
        specific_states: "{{ state_attr('climate.henry_s_room_versatile_thermostat', 'specific_states') or {} }}"
        current_temp: "{{ state_attr('climate.henry_s_room_versatile_thermostat', 'current_temperature') | float(none) }}"
        target_temp: "{{ state_attr('climate.henry_s_room_versatile_thermostat', 'temperature') | float(none) }}"
        preset_mode: "{{ state_attr('climate.henry_s_room_versatile_thermostat', 'preset_mode') }}"
        hvac_mode: "{{ states('climate.henry_s_room_versatile_thermostat') }}"
        slope: "{{ specific_states.temperature_slope | float(none) }}"
        drift: >
          {{ current_temp - target_temp if current_temp is not none and target_temp is not none else none }}

    # Step 5: Check overshoot using slope and drift (preserve comfort preset)
    - choose:
        # Overcooled while cooling: falling slope + drift <= -2°C -> switch to heat
        - conditions:
            - condition: template
              value_template: >
                {{ preset_mode is not none and preset_mode != 'none'
                   and hvac_mode == 'cool'
                   and slope is not none and slope < 0
                   and drift is not none and drift <= -2 }}
          sequence:
            - action: climate.set_hvac_mode
              target:
                entity_id: climate.henry_s_room_versatile_thermostat
              data:
                hvac_mode: heat

        # Overheated while heating: rising slope + drift >= +2°C -> switch to cool
        - conditions:
            - condition: template
              value_template: >
                {{ preset_mode is not none and preset_mode != 'none'
                   and hvac_mode == 'heat'
                   and slope is not none and slope > 0
                   and drift is not none and drift >= 2 }}
          sequence:
            - action: climate.set_hvac_mode
              target:
                entity_id: climate.henry_s_room_versatile_thermostat
              data:
                hvac_mode: cool
  mode: single

- id: lucas_room_time_based_night
  alias: "HVAC - Lucas's Room - Nighttime Eco/Boost"
  description: "Set Lucas's room to eco (heat) or boost (cool) during nighttime (bed to wake)."
  triggers:
    - trigger: time
      at: input_datetime.bedtime_lucas_room
      id: bed_time
    - trigger: state
      entity_id: input_select.occupancy
      to: Sleeping
      id: going_to_sleep
    - trigger: state
      entity_id: input_boolean.climate_manual_control_study
      to: "off"
      id: manual_override_cleared
    - trigger: state
      entity_id: climate.henry_s_room_versatile_thermostat
      attribute: current_temperature
      id: climate_current_temp_change
    - trigger: state
      entity_id: climate.henry_s_room_versatile_thermostat
      attribute: temperature
      id: climate_target_temp_change
  conditions:
    # Gate 1: Manual override must be off
    - condition: state
      entity_id: input_boolean.climate_manual_control_study
      state: "off"
    # Gate 2: Occupancy must be Home or Sleeping
    - condition: or
      conditions:
        - condition: state
          entity_id: input_select.occupancy
          state: Home
        - condition: state
          entity_id: input_select.occupancy
          state: Sleeping
    # Time must be within nighttime (bed to wake, wraps midnight)
    - condition: template
      value_template: >
        {% set wake = states('input_datetime.wakeup_time_lucas_room') %}
        {% set bed = states('input_datetime.bedtime_lucas_room') %}
        {% set now_time = now().strftime('%H:%M:%S') %}
        {{ now_time >= bed or now_time < wake }}
  actions:
    # Step 1: Set the correct nighttime preset based on season
    - choose:
        # Winter/Autumn - Use eco preset for energy-efficient heating
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: input_select.climate_season
                  state: winter
                - condition: state
                  entity_id: input_select.climate_season
                  state: autumn
          sequence:
            - action: climate.set_preset_mode
              target:
                entity_id: climate.henry_s_room_versatile_thermostat
              data:
                preset_mode: eco
            - action: climate.set_hvac_mode
              target:
                entity_id: climate.henry_s_room_versatile_thermostat
              data:
                hvac_mode: heat

        # Summer/Spring - Use boost preset for aggressive cooling
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: input_select.climate_season
                  state: summer
                - condition: state
                  entity_id: input_select.climate_season
                  state: spring
          sequence:
            - action: climate.set_preset_mode
              target:
                entity_id: climate.henry_s_room_versatile_thermostat
              data:
                preset_mode: boost
            - action: climate.set_hvac_mode
              target:
                entity_id: climate.henry_s_room_versatile_thermostat
              data:
                hvac_mode: cool

    # Step 2: Wait briefly for preset to apply and target temp to update
    - delay:
        seconds: 2

    # Step 3: Calculate drift and slope from the nighttime preset's target
    - variables:
        specific_states: "{{ state_attr('climate.henry_s_room_versatile_thermostat', 'specific_states') or {} }}"
        current_temp: "{{ state_attr('climate.henry_s_room_versatile_thermostat', 'current_temperature') | float(none) }}"
        target_temp: "{{ state_attr('climate.henry_s_room_versatile_thermostat', 'temperature') | float(none) }}"
        preset_mode: "{{ state_attr('climate.henry_s_room_versatile_thermostat', 'preset_mode') }}"
        hvac_mode: "{{ states('climate.henry_s_room_versatile_thermostat') }}"
        slope: "{{ specific_states.temperature_slope | float(none) }}"
        drift: >
          {{ current_temp - target_temp if current_temp is not none and target_temp is not none else none }}

    # Step 4: Check overshoot using slope and drift (preserve preset)
    - choose:
        # Overcooled while cooling: falling slope + drift <= -2°C -> switch to heat
        - conditions:
            - condition: template
              value_template: >
                {{ preset_mode is not none and preset_mode != 'none'
                   and hvac_mode == 'cool'
                   and slope is not none and slope < 0
                   and drift is not none and drift <= -2 }}
          sequence:
            - action: climate.set_hvac_mode
              target:
                entity_id: climate.henry_s_room_versatile_thermostat
              data:
                hvac_mode: heat

        # Overheated while heating: rising slope + drift >= +2°C -> switch to cool
        - conditions:
            - condition: template
              value_template: >
                {{ preset_mode is not none and preset_mode != 'none'
                   and hvac_mode == 'heat'
                   and slope is not none and slope > 0
                   and drift is not none and drift >= 2 }}
          sequence:
            - action: climate.set_hvac_mode
              target:
                entity_id: climate.henry_s_room_versatile_thermostat
              data:
                hvac_mode: cool
  mode: single

- id: lucas_room_away_mode
  alias: "HVAC - Lucas's Room - Away Mode"
  description: "Set Lucas's room to eco when away."
  triggers:
    - trigger: state
      entity_id: input_select.occupancy
      to:
        - Away
        - Holiday
      id: away
  conditions: []
  actions:
    - action: climate.set_preset_mode
      target:
        entity_id: climate.henry_s_room_versatile_thermostat
      data:
        preset_mode: eco
    - action: climate.set_hvac_mode
      target:
        entity_id: climate.henry_s_room_versatile_thermostat
      data:
        hvac_mode: "off"
  mode: single
