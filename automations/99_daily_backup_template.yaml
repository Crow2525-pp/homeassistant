---
# ============================================================================
# DAILY BACKUP AUTOMATION - TEMPLATE
# ============================================================================
# Purpose: Automated daily backups at 3:00 AM with notifications
# Trigger: Time-based (3:00 AM daily)
# Action: Create backup, send notification
# Requirements: Home Assistant with Supervisor backups (hassio.backup_full service)
#
# Setup Instructions:
# 1. Verify hassio.backup_full service exists (Developer Tools > Services)
# 2. Customize notification service (persistent, mobile, email)
# 3. (Optional) Adjust backup time
# 4. Test backup manually before deploying
# 5. Rename file to remove "99_" prefix (e.g., 11_daily_backup.yaml)
#
# Documentation: docs/BACKUP_AUTOMATION_SETUP.md
# ============================================================================

- id: system_daily_backup_3am
  alias: "System - Daily Backup (3 AM)"
  description: "Create automated backup at 3:00 AM daily with notifications"

  # ============================================================================
  # TRIGGER: Daily at 3:00 AM
  # ============================================================================
  trigger:
    - platform: time
      at: "03:00:00"  # CUSTOMIZE: Change time if desired (avoid peak usage hours)
      id: scheduled_backup

  # ============================================================================
  # CONDITIONS: Optional Conditions
  # ============================================================================
  condition:
    # Only run if backup system is healthy
    # Uncomment to add conditions:
    # - condition: state
    #   entity_id: binary_sensor.disk_space_available
    #   state: "on"

    # Skip backups on specific days (e.g., maintenance window)
    # - condition: template
    #   value_template: "{{ now().weekday() not in [6] }}"  # Skip Sundays

  # ============================================================================
  # ACTIONS: Create Backup and Notify
  # ============================================================================
  action:
    # Action 1: Create backup using Supervisor service (REQUIRED - widely compatible)
    # IMPORTANT: Use hassio.backup_full ONLY. Do NOT use backup.create which causes
    # "unknown action" errors in many Home Assistant versions.
    - service: hassio.backup_full
      data:
        name: "Auto Backup {{ now().strftime('%Y-%m-%d') }}"
        # Optional parameters:
        # password: "your_encryption_password"  # Encrypt backup

    # Action 2: Wait for backup to complete (optional but recommended)
    - delay:
        seconds: 10

    # Action 3: Send success notification
    - service: notify.persistent_notification  # CUSTOMIZE: Change to your notification service
      data:
        title: "Backup Successful"
        message: >
          Daily backup completed successfully.

          Time: {{ now().strftime('%I:%M %p on %B %d, %Y') }}

          Backups are stored in Settings > System > Backups
        data:
          tag: "daily_backup"  # Replaces previous notification

    # Action 4 (Optional): Send mobile notification
    # Uncomment and customize:
    # - service: notify.mobile_app_your_phone
    #   data:
    #     title: "Backup Successful"
    #     message: "Daily backup completed at {{ now().strftime('%I:%M %p') }}"
    #     data:
    #       tag: "daily_backup"
    #       priority: low  # Low priority since it's routine

    # Action 5 (Optional): Log to logbook
    - service: logbook.log
      data:
        name: "System Backup"
        message: "Daily backup created successfully"

  # ============================================================================
  # ERROR HANDLING
  # ============================================================================
  # If backup fails, HA will log error automatically
  # For custom error handling, use try/except in a script

  mode: single

# ============================================================================
# BACKUP FAILURE NOTIFICATION (Optional)
# ============================================================================
# Uncomment to receive alerts when backup service fails

# - id: system_backup_failure_alert
#   alias: "System - Backup Failure Alert"
#   description: "Alert when backup service fails"
#
#   trigger:
#     # Trigger on backup service error
#     - platform: event
#       event_type: call_service
#       event_data:
#         domain: hassio
#         service: backup_full
#
#   condition:
#     # Only trigger if service call failed
#     - condition: template
#       value_template: "{{ trigger.event.data.success == false }}"
#
#   action:
#     # Send high-priority failure notification
#     - service: notify.persistent_notification
#       data:
#         title: "Backup Failed"
#         message: >
#           Daily backup failed at {{ now().strftime('%I:%M %p') }}.
#
#           Please check:
#           - Disk space available
#           - Home Assistant logs
#           - Backup service status
#
#           Manual backup recommended.
#         data:
#           tag: "backup_failure"
#
#     # Optional: Send high-priority mobile notification
#     # - service: notify.mobile_app_your_phone
#     #   data:
#     #     title: "Backup Failed!"
#     #     message: "Daily backup failed. Check HA immediately."
#     #     data:
#       #       priority: high
#       #       tag: "backup_failure"
#
#   mode: single

# ============================================================================
# CUSTOMIZATION CHECKLIST
# ============================================================================
# [ ] Verify hassio.backup_full service exists (Developer Tools > Services)
# [ ] Customize backup time (default: 3:00 AM)
# [ ] Configure notification service (persistent, mobile, email)
# [ ] (Optional) Enable backup failure alert
# [ ] (Optional) Add backup encryption password
# [ ] Test backup creation manually
# [ ] Verify backup file appears in Settings > System > Backups
# [ ] Rename file to remove "99_" prefix for production
#
# TROUBLESHOOTING:
# - If you see "unknown action: backup.create" error: Ensure you're using
#   hassio.backup_full service, not backup.create
# - If backup fails to run: Check that the service exists in Developer Tools
# - If you're on Home Assistant OS: You may need to use supervisor.backup_full
#
