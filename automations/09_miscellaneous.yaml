---
- id: master_bedroom_fan_climate_control
  alias: HVAC - Master Bedroom Fan Sync with Climate
  description: 'Synchronizes master bedroom fan with versatile thermostat state. Fan
    turns off when heating, adjusts speed based on cooling temperature difference,
    and stays on overnight during AC cooling between bedtime and wake.

    '
  triggers:
  - platform: state
    entity_id: climate.masterbed_room_ac
    to: cool
    id: cooling_started
  - platform: state
    entity_id: climate.masterbed_room_ac
    attribute: current_temperature
    id: cooling_temp_changed
  - platform: state
    entity_id: climate.masterbed_room_ac
    attribute: temperature
    id: cooling_target_changed
  - platform: state
    entity_id: climate.masterbed_room_ac
    to: heat
    id: heating_started
  - platform: state
    entity_id: climate.masterbed_room_ac
    to: 'off'
    id: climate_off
  - platform: time
    at: input_datetime.bedtime_master_bedroom
    id: bedtime
  - platform: state
    entity_id: fan.masterbedroom_fan
    to: 'off'
    id: fan_turned_off
  conditions:
  - condition: state
    entity_id: input_boolean.fan_manual_control_master
    state: 'off'
  actions:
  - choose:
    - conditions:
      - condition: or
        conditions:
        - condition: trigger
          id: cooling_started
        - condition: trigger
          id: cooling_temp_changed
        - condition: trigger
          id: cooling_target_changed
      - condition: state
        entity_id: climate.masterbed_room_ac
        state: cool
      sequence:
      - service: fan.set_percentage
        target:
          entity_id: fan.masterbedroom_fan
        data:
          percentage: >
            {% set current = state_attr('climate.masterbed_room_ac', 'current_temperature') %}
            {% set target = state_attr('climate.masterbed_room_ac', 'temperature') %}
            {% if current is number and target is number %}
              {% set diff = current - target %}
              {% if diff <= 1 %}
                16
              {% elif diff <= 2 %}
                33
              {% elif diff <= 3 %}
                50
              {% elif diff <= 4 %}
                66
              {% elif diff <= 5 %}
                83
              {% else %}
                100
              {% endif %}
            {% else %}
              16
            {% endif %}
    - conditions:
      - condition: or
        conditions:
        - condition: trigger
          id: bedtime
        - condition: trigger
          id: fan_turned_off
      - condition: state
        entity_id: climate.masterbed_room_ac
        state: cool
      - condition: template
        value_template: >
          {% set wake = states('input_datetime.wakeup_time_master_bedroom') %}
          {% set bed = states('input_datetime.bedtime_master_bedroom') %}
          {% set now_time = now().strftime('%H:%M:%S') %}
          {{ now_time >= bed or now_time < wake }}
      - condition: state
        entity_id: fan.masterbedroom_fan
        state: 'off'
      sequence:
      - service: fan.set_percentage
        target:
          entity_id: fan.masterbedroom_fan
        data:
          percentage: >
            {% set current = state_attr('climate.masterbed_room_ac', 'current_temperature') %}
            {% set target = state_attr('climate.masterbed_room_ac', 'temperature') %}
            {% if current is number and target is number %}
              {% set diff = current - target %}
              {% if diff <= 1 %}
                16
              {% elif diff <= 2 %}
                33
              {% elif diff <= 3 %}
                50
              {% elif diff <= 4 %}
                66
              {% else %}
                66
              {% endif %}
            {% else %}
              16
            {% endif %}
    - conditions:
      - condition: trigger
        id: heating_started
      sequence:
      - service: fan.turn_off
        target:
          entity_id: fan.masterbedroom_fan
    - conditions:
      - condition: trigger
        id: climate_off
      sequence:
      - service: fan.turn_off
        target:
          entity_id: fan.masterbedroom_fan
  mode: restart
