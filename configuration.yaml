# Configure a default setup of Home Assistant (frontend, api, etc)
default_config:

# Customize entities
homeassistant:
  customize: !include customize.yaml

# Text to speech
tts:
  - platform: google_translate

sensor: !include mysensors.yaml
group: !include groups.yaml
automation: !include automations.yaml
script: !include scripts.yaml
scene: !include scenes.yaml
climate: !include climate.yaml
fan: !include fan.yaml
media_player: !include media_player.yaml
template: !include templates.yaml
mqtt: !include mqtt.yaml
notify: !include notifications.yaml

lovelace:
  mode: yaml
  resources:
    - url: /hacsfiles/lovelace-card-mod/card-mod.js
      type: module
    - url: /hacsfiles/bar-card/bar-card.js
      type: module
    - url: /hacsfiles/better-thermostat-ui-card/better-thermostat-ui-card.js
      type: module
    - url: /hacsfiles/lovelace-auto-entities/auto-entities.js
      type: module
    - url: /hacsfiles/lovelace-template-entity-row/template-entity-row.js
      type: module
    - url: /hacsfiles/config-template-card/config-template-card.js
      type: module
    - url: /hacsfiles/upcoming-media-card/upcoming-media-card.js
      type: module
    - url: /hacsfiles/button-card/button-card.js
      type: module
    - url: /hacsfiles/mini-graph-card/mini-graph-card-bundle.js
      type: module
    - url: /hacsfiles/mini-media-player/mini-media-player-bundle.js
      type: module
    - url: /hacsfiles/my-cards/my-cards.js
      type: module
    - url: /hacsfiles/light-entity-card/dist/light-entity-card.js
      type: module
    - url: /hacsfiles/simple-weather-card/simple-weather-card-bundle.js
      type: module
    - url: /hacsfiles/weather-radar-card/weather-radar-card.js
      type: module
    - url: /hacsfiles/lovelace-state-switch/state-switch.js
      type: module
    - url: /hacsfiles/week-planner-card/week-planner-card.js
      type: module
    - url: /hacsfiles/lovelace-navbar-card/navbar-card.js
      type: module
    - url: /local/community/lovelace-layout-card/layout-card.js
      type: module

logger:
  default: warning
  # logs:
  #   custom_components.smartir.climate: debug
  #   custom_components.smartir.fan: debug
  #   custom_components.versatile_thermostat: debug

frontend:
  themes: !include_dir_merge_named themes
  extra_module_url:
    - /local/card-mod.js

http:
  use_x_forwarded_for: true
  trusted_proxies:
    - 192.168.1.103
    - 192.168.1.90
    - 192.168.1.14
    - 192.168.1.16
    - 192.168.1.98
    - 172.30.33.0/24
    - 127.0.0.1

#Roller Blinds
cover:
  - platform: template
    covers:
      roller_blinds_chan1:
        device_class: blind
        friendly_name: "Roller blinds (MasterBedroom)"
        unique_id: "roller_blinds_MasterBedroom"

        # Read position from tracked helper (Broadlink covers don't report position)
        position_template: "{{ states('input_number.roller_blind_position') | int(0) }}"

        # Use the state tracking helper
        value_template: >-
          {% set state = states('input_select.roller_blind_state') %}
          {% if state in ['opening', 'open'] %}
            open
          {% elif state in ['closing', 'closed'] %}
            closed
          {% else %}
            open
          {% endif %}

        # Quick, non-blocking actions
        open_cover:
          - action: input_select.select_option
            target:
              entity_id: input_select.roller_blind_state
            data:
              option: "opening"
          - action: script.roller_blinds_up
          - action: timer.start
            target:
              entity_id: timer.roller_blind_timer
            data:
              duration: "00:18:00"

        close_cover:
          - action: input_select.select_option
            target:
              entity_id: input_select.roller_blind_state
            data:
              option: "closing"
          - action: script.roller_blinds_down
          - action: timer.start
            target:
              entity_id: timer.roller_blind_timer
            data:
              duration: "00:18:00"

        stop_cover:
          - action: script.roller_blinds_stop
          - action: timer.cancel
            target:
              entity_id: timer.roller_blind_timer
          - action: input_select.select_option
            target:
              entity_id: input_select.roller_blind_state
            data:
              option: "{{ 'open' if states('input_number.roller_blind_position') | int(0) > 50 else 'closed' }}"

        # Allow setting position (CCA needs this)
        set_cover_position:
          # Always set target position first
          - action: input_number.set_value
            target:
              entity_id: input_number.roller_blind_target_position
            data:
              value: "{{ position }}"
          # Then start appropriate movement (only if difference > 5%)
          - choose:
              # If target is 100, open fully
              - conditions: "{{ position == 100 }}"
                sequence:
                  - action: input_select.select_option
                    target:
                      entity_id: input_select.roller_blind_state
                    data:
                      option: "opening"
                  - action: script.roller_blinds_up
                  - action: timer.start
                    target:
                      entity_id: timer.roller_blind_timer
                    data:
                      duration: "00:18:00"
              # If target is 0, close fully
              - conditions: "{{ position == 0 }}"
                sequence:
                  - action: input_select.select_option
                    target:
                      entity_id: input_select.roller_blind_state
                    data:
                      option: "closing"
                  - action: script.roller_blinds_down
                  - action: timer.start
                    target:
                      entity_id: timer.roller_blind_timer
                    data:
                      duration: "00:18:00"
              # For partial positions, only move if difference > 5%
              - conditions: >-
                  {{ position > 0 and position < 100 and
                     (position - states('input_number.roller_blind_position') | int(0)) | abs > 5 }}
                sequence:
                  - action: input_select.select_option
                    target:
                      entity_id: input_select.roller_blind_state
                    data:
                      option: "{{ 'opening' if position > states('input_number.roller_blind_position') | int(0) else 'closing' }}"
                  - choose:
                      - conditions: "{{ position > states('input_number.roller_blind_position') | int(0) }}"
                        sequence:
                          - action: script.roller_blinds_up
                      - conditions: "{{ position < states('input_number.roller_blind_position') | int(0) }}"
                        sequence:
                          - action: script.roller_blinds_down
                  - action: timer.start
                    target:
                      entity_id: timer.roller_blind_timer
                    data:
                      duration: "00:18:00"

light:
  - platform: template
    lights:
      tv_backlight:
        friendly_name: "TV Back Lightstrip"
        unique_id: light.tv_backlight
        icon_template: "mdi:television-ambient-light"
        turn_on:
          action: script.tv_lights_on
        turn_off:
          action: script.tv_lights_off

adaptive_lighting:

battery_notes:

recorder:
  purge_keep_days: 730
  exclude:
    entity_globs:
      - sensor.*_rssi
      - sensor.*_linkquality
      - sensor.*_last_seen
      - sensor.*_last_boot
      - sensor.*_uptime
      - update.*

# Garage Door Sensors
input_boolean:
  garage_door_notify:
    name: Garage Door Notify

    icon: mdi:information
  network_device_down_notify:
    name: Network Device Down Notify

    icon: mdi:alert
  wan_down_notify:
    name: WAN Down Notify
    icon: mdi:alert
  blind_manual_control:
    name: Blinds Manual Control Override
    icon: mdi:blinds
    initial: false
  climate_manual_control_living:
    name: Living Room Climate Manual Override
    icon: mdi:thermostat
    initial: false
  climate_manual_control_master:
    name: Master Bedroom Climate Manual Override
    icon: mdi:thermostat
    initial: false
  climate_manual_control_otto:
    name: Otto's Room Climate Manual Override
    icon: mdi:thermostat
    initial: false
  climate_manual_control_study:
    name: Study Climate Manual Override
    icon: mdi:thermostat
    initial: false
  super_hot_today:
    name: Super Hot Day Flag
    icon: mdi:weather-sunny-alert
    initial: false
  hot_today_flag:
    name: Hot Day Flag
    icon: mdi:weather-sunny
    initial: false
  warm_today_flag:
    name: Warm Day Flag
    icon: mdi:weather-partly-sunny
    initial: false
  downstairs_doors_open:
    name: Downstairs Doors Open
    icon: mdi:door-open
    initial: false
  # HVAC Master Switches - Track whether automation thinks HVAC should be on (Principle #11)
  hvac_master_bedroom_should_be_on:
    name: Master Bedroom HVAC Should Be On
    icon: mdi:thermometer
    initial: false
  hvac_living_room_should_be_on:
    name: Living Room HVAC Should Be On
    icon: mdi:thermometer
    initial: false
  hvac_study_should_be_on:
    name: Study HVAC Should Be On
    icon: mdi:thermometer
    initial: false
  hvac_kids_room_should_be_on:
    name: Kids Room HVAC Should Be On
    icon: mdi:thermometer
    initial: false

# Cover Control Automation Status Helpers
input_text:
  cover_status_helper:
    name: Roller Blinds Cover Status Helper
    max: 254
    initial: "unknown"
    icon: mdi:roller-shade
  cover_status_helper_curtains:
    name: Curtains Cover Status Helper
    max: 254
    initial: "unknown"
    icon: mdi:curtains

input_select:
  climate_season:
    name: Climate Season
    options:
      - summer
      - autumn
      - winter
      - spring
    initial: spring
    icon: mdi:weather-partly-cloudy
  occupancy:
    name: Occupancy Mode
    options:
      - Home
      - Away
      - Holiday
    initial: Home
    icon: mdi:home-account

input_number:
  # Roller Blind Position Tracking
  roller_blind_target_position:
    name: Roller Blind Target Position
    min: 0
    max: 100
    step: 1
    initial: 0
    mode: box
    icon: mdi:target
    unit_of_measurement: '%'
  # Climate Control Helpers
  living_room_heat_lead_minutes:
    name: Living Room Heat Lead Minutes
    icon: mdi:timer-plus
    min: 0
    max: 120
    step: 5
    unit_of_measurement: min
    initial: 30
  living_room_heat_comfort_minutes:
    name: Living Room Heat Comfort Window
    icon: mdi:timer-off
    min: 10
    max: 120
    step: 5
    unit_of_measurement: min
    initial: 45
  # Master Bedroom Climate Thresholds
  master_bedroom_temp_summer_cool:
    name: Master Bedroom Summer Cooling Threshold
    min: 22
    max: 28
    step: 0.5
    initial: 26
    unit_of_measurement: "°C"
    icon: mdi:thermometer-chevron-up
  master_bedroom_temp_winter_heat:
    name: Master Bedroom Winter Heating Threshold
    min: 14
    max: 20
    step: 0.5
    initial: 16
    unit_of_measurement: "°C"
    icon: mdi:thermometer-chevron-down
  master_bedroom_temp_comfort_low:
    name: Master Bedroom Comfort Low
    min: 16
    max: 22
    step: 0.5
    initial: 18
    unit_of_measurement: "°C"
    icon: mdi:thermometer
  master_bedroom_temp_comfort_high:
    name: Master Bedroom Comfort High
    min: 20
    max: 28
    step: 0.5
    initial: 22
    unit_of_measurement: "°C"
    icon: mdi:thermometer
  # Living Room Climate Thresholds
  living_room_temp_summer_cool:
    name: Living Room Summer Cooling Threshold
    min: 24
    max: 32
    step: 0.5
    initial: 28
    unit_of_measurement: "°C"
    icon: mdi:thermometer-chevron-up
  living_room_temp_winter_heat:
    name: Living Room Winter Heating Threshold
    min: 16
    max: 22
    step: 0.5
    initial: 19
    unit_of_measurement: "°C"
    icon: mdi:thermometer-chevron-down
  living_room_temp_winter_morning:
    name: Living Room Winter Morning Preheat Threshold
    min: 16
    max: 21
    step: 0.5
    initial: 19
    unit_of_measurement: "°C"
    icon: mdi:thermometer-clock
  living_room_temp_comfort:
    name: Living Room Comfort Temperature
    min: 18
    max: 24
    step: 0.5
    initial: 20
    unit_of_measurement: "°C"
    icon: mdi:thermometer

input_datetime:
  last_climate_notification_living:
    name: Last Climate Notification - Living Room
    has_date: true
    has_time: true
  last_climate_notification_master:
    name: Last Climate Notification - Master Bedroom
    has_date: true
    has_time: true
  ac_filter_living_room:
    name: AC Filter Last Changed - Living Room
    has_date: true
    has_time: true
  ac_filter_master_bedroom:
    name: AC Filter Last Changed - Master Bedroom
    has_date: true
    has_time: true
  ac_filter_otto_room:
    name: AC Filter Last Changed - Otto's Room
    has_date: true
    has_time: true
  ac_filter_study_henry:
    name: AC Filter Last Changed - Study/Henry's Room
    has_date: true
    has_time: true

alert:
  garage_door_info_alert_active:
    name: Garage Door Alert Active
    entity_id: binary_sensor.garage_door_alert_active
    state: "on"
    repeat:
      - 180
    can_acknowledge: true
    skip_first: true
    title: "7580 Info - Garage Door Open"
    message: >
      Garage Door open for {{ relative_time(states.binary_sensor.garage_door_alert_active.last_changed) }} \  
      Alerts on: {{ cover.smart_garage_door_garage | selectattr('state', 'eq', 'on') | map(attribute='attributes.friendly_name') | list | join(', ') }} \ 
      Triggered: {{ as_timestamp(states.binary_sensor.garage_door_alert_active.last_changed) | timestamp_custom('%A %I:%M%p (%d-%b-%Y)') }}
    done_message: "Garage Door Alert RESOLVED at {{ as_timestamp(states.binary_sensor.garage_door_alert_active.last_changed) | timestamp_custom('%A %I:%M%p (%d-%b-%Y)') }}"
    notifiers:
      - STD_Information

  network_device_down_warn_alert_active:
    name: Network Device Down Alert Active
    entity_id: binary_sensor.network_device_down_alert_active
    state: "on"
    repeat:
      - 3
      - 10
      - 30
      - 60
    can_acknowledge: true
    skip_first: false
    title: "7580 Warning - Network Device Down"
    message: >
      Network device down for {{ relative_time(states.binary_sensor.network_device_down_alert_active.last_changed) }} \  
      Alerts on: {{ expand('group.network_devices') | selectattr('state', 'eq', 'off') | map(attribute='attributes.friendly_name') | list | join(', ') }} \ 
      Triggered: {{ as_timestamp(states.binary_sensor.network_device_down_alert_active.last_changed) | timestamp_custom('%A %I:%M%p (%d-%b-%Y)') }}
    done_message: "Network Device Down Alert RESOLVED at {{ as_timestamp(states.binary_sensor.network_device_down_alert_active.last_changed) | timestamp_custom('%A %I:%M%p (%d-%b-%Y)') }}"
    notifiers:
      - STD_Warning
  wan_down_warn_alert_active:
    name: WAN Down Alert Active
    entity_id: binary_sensor.wan_down_alert_active
    state: "on"
    repeat:
      - 3
      - 10
      - 30
      - 60
    can_acknowledge: true
    skip_first: false
    title: "⚠️ WAN Down"
    message: >
      WAN has been down for {{ relative_time(states.binary_sensor.wan_down_alert_active.last_changed) }}.
      Please check your WAN connection.
    done_message: "✅ WAN Down Alert RESOLVED at {{ as_timestamp(states.binary_sensor.wan_down_alert_active.last_changed) | timestamp_custom('%A %I:%M%p (%d-%b-%Y)') }}"
    notifiers:
      - STD_Warning

