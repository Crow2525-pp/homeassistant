- binary_sensor:
    - name: Garage Door Alert Active
      state: "{{ is_state('cover.smart_garage_door_garage', 'open')}}"

- binary_sensor:
    ## Down alerts have 250 second delay built in before activating
    - name: Network Device Down Alert Active
      state: "{{ (is_state('group.network_devices', 'off') and ((as_timestamp(now()) - as_timestamp(states.group.network_devices.last_changed)) | int(0) > 250 )) and is_state('input_boolean.network_device_down_notify', 'on') }}"
    - name: WAN Down Alert Active
      state: "{{ (is_state('group.wan_devices', 'off') and ((as_timestamp(now()) - as_timestamp(states.group.wan_devices.last_changed)) | int(0) > 250 )) and is_state('input_boolean.wan_down_notify', 'on') }}"

- binary_sensor:
    ## Internet Connection Status based on TX and RX
    - name: Internet Connection
      state: "{{ ((states('sensor.ucg_ultra_port_5_tx') | float > 0) or (states('sensor.ucg_ultra_port_5_rx') | float > 0)) }}"

    ## WAN Down Alert Active with 250-second delay
    - name: WAN Down Alert Active
      state: "{{ ((states('sensor.ucg_ultra_port_5_tx') | float == 0) and (states('sensor.ucg_ultra_port_5_rx') | float == 0) and ((as_timestamp(now()) - as_timestamp(states.sensor.ucg_ultra_port_5_tx.last_changed)) | int(0) > 250)) }}"

- binary_sensor:
    - name: "Holiday Season"
      unique_id: holiday_season
      state: "{{ now().month == 11 or now().month == 12 }}"

    - name: "Someone Home"
      unique_id: someone_home
      state: "{{ states('input_select.occupancy') in ['Home', 'Sleeping', 'Guest'] }}"
      icon: "mdi:home-account"

    - name: "External Door Open at Night"
      unique_id: external_door_open_at_night
      state: >
        {% set is_night = states('sun.sun') == 'below_horizon' %}
        {% set doors_open = is_state('binary_sensor.front_door_sensor_opening', 'on')
          or is_state('binary_sensor.side_garage_door_sensor_magnet_opening', 'on')
          or is_state('binary_sensor.balcony_door_sensor_magnet_opening_2', 'on')
          or is_state('binary_sensor.living_room_door_sensor_opening', 'on')
          or is_state('binary_sensor.interior_garage_door_sensor_magnet_opening', 'on') %}
        {{ is_night and doors_open }}
      icon: "mdi:door-open"

- sensor:
    - name: "Relevant Weather Warnings Count"
      unique_id: relevant_weather_warnings_count
      state: >
        {% set warnings = state_attr('sensor.braybrook_warnings', 'warnings') %}
        {% if warnings %}
          {% set relevant = warnings | selectattr('title', 'defined') | rejectattr('title', 'search', 'sheep|marine|coastal|grazier', ignorecase=True) | list %}
          {{ relevant | length }}
        {% else %}
          0
        {% endif %}
      icon: "mdi:weather-lightning"

    - name: "Maintenance Dates Summary"
      state: >
        {% set items = states.input_datetime
          | selectattr('attributes.label', 'defined')
          | selectattr('attributes.label', 'equalto', 'Maintenance')
          | map(attribute='entity_id')
          | list %}
        {% for e in items %}
        - {{ state_attr(e, 'friendly_name') }}: {{ states(e) }}
        {% endfor %}

- sensor:
    - name: "Washing Machine Estimated Remaining"
      unique_id: washing_machine_estimated_remaining
      state: >
        {% set cycle_time = 55 %}
        {% if is_state('input_boolean.washing_machine_on', 'on') and states.input_boolean.washing_machine_on.last_changed %}
          {% set last_changed = as_timestamp(states.input_boolean.washing_machine_on.last_changed) %}
          {% if last_changed is not none %}
            {% set elapsed = (as_timestamp(now()) - last_changed) / 60 %}
            {% set remaining = cycle_time - elapsed %}
            {{ [remaining | round(0), 0] | max }} 
          {% else %}
            0
          {% endif %}
        {% else %}
          0
        {% endif %}
      attributes:
        friendly_name: "Washing Machine Estimated Remaining"
        unit_of_measurement: "min"
      icon: mdi:timer

    - name: "Dryer Estimated Remaining"
      unique_id: dryer_estimated_remaining
      state: >
        {% set cycle_time = 120 %}
        {% if is_state('input_boolean.dryer_on', 'on') and states.input_boolean.dryer_on.last_changed %}
          {% set last_changed = as_timestamp(states.input_boolean.dryer_on.last_changed) %}
          {% if last_changed is not none %}
            {% set elapsed = (as_timestamp(now()) - last_changed) / 60 %}
            {% set remaining = cycle_time - elapsed %}
            {{ [remaining | round(0), 0] | max }}
          {% else %}
            0
          {% endif %}
        {% else %}
          0
        {% endif %}
      attributes:
        friendly_name: "Dryer Estimated Remaining"
        unit_of_measurement: "min"
      icon: mdi:timer

    - name: "Living Room Temperature (Offset)"
      unique_id: livingroom_irblaster_temperature_offset
      unit_of_measurement: "Â°C"
      state: "{{ (states('sensor.livingroom_irblaster_temperature') | float + 1.7) | round(1) }}"

- trigger:
    - trigger: time_pattern
      hours: /1
  action:
    - action: weather.get_forecasts
      data:
        type: hourly
      target:
        entity_id: weather.home
      response_variable: hourly

- trigger:
    - platform: state
      entity_id:
        - sensor.ble_temperature_masterbed_temp_humidity_sensor
        - sensor.ble_humidity_masterbed_temp_humidity_sensor
        - sensor.ble_battery_masterbed_temp_humidity_sensor
  sensor:
    - name: "Masterbed Temp/Humidity Sensor Last Seen"
      state: "{{ now().isoformat() }}"

- trigger:
    - platform: state
      entity_id:
        - sensor.ble_temperature_kitchen_temp_humidity_sensor
        - sensor.ble_humidity_kitchen_temp_humidity_sensor
        - sensor.ble_voltage_kitchen_temp_humidity_sensor
        - sensor.ble_rssi_kitchen_temp_humidity_sensor
  sensor:
    - name: "Kitchen Temp/Humidity Sensor Last Seen"
      state: "{{ now().isoformat() }}"

- binary_sensor:
    # Solar excess - when exporting more than 1kW to grid
    - name: "Solar Excess Available"
      unique_id: solar_excess_available
      state: >
        {% set net_grid = states('sensor.gosungrow_virtual_1205796_7_1_1_p8018') | float(0) %}
        {{ net_grid < -1000 }}
      icon: "mdi:solar-power-variant"
      attributes:
        excess_power: >
          {% set net_grid = states('sensor.gosungrow_virtual_1205796_7_1_1_p8018') | float(0) %}
          {{ ((net_grid * -1) / 1000) | round(1) if net_grid < 0 else 0 }}

- sensor:
    # Smart appliance recommendation based on solar, season, and conditions
    - name: "Appliance Recommendation"
      unique_id: appliance_recommendation
      state: >
        {% set solar_excess = is_state('binary_sensor.solar_excess_available', 'on') %}
        {% set month = now().month %}
        {% set is_winter = month in [5, 6, 7, 8, 9, 10] %}
        {% set is_summer = month in [11, 12, 1, 2, 3] %}

        {% if solar_excess %}
          {% if is_winter %}
            heating
          {% elif is_summer %}
            cooling
          {% else %}
            laundry
          {% endif %}
        {% else %}
          none
        {% endif %}
      icon: >
        {% if is_state('sensor.appliance_recommendation', 'heating') %}
          mdi:fire
        {% elif is_state('sensor.appliance_recommendation', 'cooling') %}
          mdi:snowflake
        {% elif is_state('sensor.appliance_recommendation', 'laundry') %}
          mdi:washing-machine
        {% else %}
          mdi:lightbulb-off
        {% endif %}
      attributes:
        reason: >
          {% set solar_excess = is_state('binary_sensor.solar_excess_available', 'on') %}
          {% set excess = state_attr('binary_sensor.solar_excess_available', 'excess_power') | float(0) %}
          {% if solar_excess %}
            Excess solar: {{ excess }}kW available
          {% else %}
            No excess solar power
          {% endif %}

- sensor:
    # Room climate recommendations
    - name: "Living Room Climate Suggestion"
      unique_id: living_room_climate_suggestion
      state: >
        {% set temp = states('sensor.living_room_temperature_offset') | float(0) %}
        {% set outside_temp = state_attr('weather.braybrook', 'temperature') | float(20) %}
        {% set month = now().month %}
        {% set is_winter = month in [5, 6, 7, 8, 9, 10] %}
        {% set is_summer = month in [11, 12, 1, 2, 3] %}
        {% set is_shoulder = month in [4] %}
        {% set solar_excess = is_state('binary_sensor.solar_excess_available', 'on') %}

        {% if is_winter and temp < 18 and solar_excess %}
          heat_now
        {% elif is_summer and temp > 26 and solar_excess %}
          cool_now
        {% elif is_shoulder and temp < 19 and solar_excess %}
          heat_now
        {% elif is_shoulder and temp > 25 and solar_excess %}
          cool_now
        {% elif is_winter and temp < 16 %}
          heat_needed
        {% elif is_summer and temp > 28 %}
          cool_needed
        {% elif is_shoulder and temp < 17 %}
          heat_needed
        {% elif is_shoulder and temp > 27 %}
          cool_needed
        {% else %}
          comfortable
        {% endif %}
      icon: "mdi:home-thermometer"
      attributes:
        current_temp: "{{ states('sensor.living_room_temperature_offset') }}"
        outside_temp: "{{ state_attr('weather.braybrook', 'temperature') }}"
        message: >
          {% set temp = states('sensor.living_room_temperature_offset') | float(0) %}
          {% set state = states('sensor.living_room_climate_suggestion') %}
          {% if state == 'heat_now' %}
            ðŸ”¥ Good time to heat! Excess solar available and room is {{ temp }}Â°C
          {% elif state == 'cool_now' %}
            â„ï¸ Good time to cool! Excess solar available and room is {{ temp }}Â°C
          {% elif state == 'heat_needed' %}
            Room is cold ({{ temp }}Â°C) but no excess solar
          {% elif state == 'cool_needed' %}
            Room is warm ({{ temp }}Â°C) but no excess solar
          {% else %}
            Room temperature is comfortable ({{ temp }}Â°C)
          {% endif %}

    - name: "Master Bedroom Climate Suggestion"
      unique_id: master_bedroom_climate_suggestion
      state: >
        {% set temp = states('sensor.ble_temperature_masterbed_temp_humidity_sensor') | float(0) %}
        {% set month = now().month %}
        {% set is_winter = month in [5, 6, 7, 8, 9, 10] %}
        {% set is_summer = month in [11, 12, 1, 2, 3] %}
        {% set is_shoulder = month in [4] %}
        {% set solar_excess = is_state('binary_sensor.solar_excess_available', 'on') %}

        {% if is_winter and temp < 18 and solar_excess %}
          heat_now
        {% elif is_summer and temp > 26 and solar_excess %}
          cool_now
        {% elif is_shoulder and temp < 19 and solar_excess %}
          heat_now
        {% elif is_shoulder and temp > 25 and solar_excess %}
          cool_now
        {% elif is_winter and temp < 16 %}
          heat_needed
        {% elif is_summer and temp > 28 %}
          cool_needed
        {% elif is_shoulder and temp < 17 %}
          heat_needed
        {% elif is_shoulder and temp > 27 %}
          cool_needed
        {% else %}
          comfortable
        {% endif %}
      icon: "mdi:bed-thermometer"
      attributes:
        current_temp: "{{ states('sensor.ble_temperature_masterbed_temp_humidity_sensor') }}"
        message: >
          {% set temp = states('sensor.ble_temperature_masterbed_temp_humidity_sensor') | float(0) %}
          {% set state = states('sensor.master_bedroom_climate_suggestion') %}
          {% if state == 'heat_now' %}
            ðŸ”¥ Good time to heat! Excess solar available and room is {{ temp }}Â°C
          {% elif state == 'cool_now' %}
            â„ï¸ Good time to cool! Excess solar available and room is {{ temp }}Â°C
          {% elif state == 'heat_needed' %}
            Room is cold ({{ temp }}Â°C) but no excess solar
          {% elif state == 'cool_needed' %}
            Room is warm ({{ temp }}Â°C) but no excess solar
          {% else %}
            Room temperature is comfortable ({{ temp }}Â°C)
          {% endif %}

    - name: "Henry's Room Climate Suggestion"
      unique_id: henrys_room_climate_suggestion
      state: >
        {% set temp = states('sensor.study_esp32_henrysroom_temperature') | float(0) %}
        {% set month = now().month %}
        {% set is_winter = month in [5, 6, 7, 8, 9, 10] %}
        {% set is_summer = month in [11, 12, 1, 2, 3] %}
        {% set is_shoulder = month in [4] %}
        {% set solar_excess = is_state('binary_sensor.solar_excess_available', 'on') %}

        {% if is_winter and temp < 18 and solar_excess %}
          heat_now
        {% elif is_summer and temp > 26 and solar_excess %}
          cool_now
        {% elif is_shoulder and temp < 19 and solar_excess %}
          heat_now
        {% elif is_shoulder and temp > 25 and solar_excess %}
          cool_now
        {% elif is_winter and temp < 16 %}
          heat_needed
        {% elif is_summer and temp > 28 %}
          cool_needed
        {% elif is_shoulder and temp < 17 %}
          heat_needed
        {% elif is_shoulder and temp > 27 %}
          cool_needed
        {% else %}
          comfortable
        {% endif %}
      icon: "mdi:thermometer"
      attributes:
        current_temp: "{{ states('sensor.study_esp32_henrysroom_temperature') }}"
        message: >
          {% set temp = states('sensor.study_esp32_henrysroom_temperature') | float(0) %}
          {% set state = states('sensor.henrys_room_climate_suggestion') %}
          {% if state == 'heat_now' %}
            ðŸ”¥ Good time to heat! Excess solar available and room is {{ temp }}Â°C
          {% elif state == 'cool_now' %}
            â„ï¸ Good time to cool! Excess solar available and room is {{ temp }}Â°C
          {% elif state == 'heat_needed' %}
            Room is cold ({{ temp }}Â°C) but no excess solar
          {% elif state == 'cool_needed' %}
            Room is warm ({{ temp }}Â°C) but no excess solar
          {% else %}
            Room temperature is comfortable ({{ temp }}Â°C)
          {% endif %}

    - name: "Otto's Room Climate Suggestion"
      unique_id: ottos_room_climate_suggestion
      state: >
        {% set temp = states('sensor.study_esp32_ottosroom_temperature') | float(0) %}
        {% set month = now().month %}
        {% set is_winter = month in [5, 6, 7, 8, 9, 10] %}
        {% set is_summer = month in [11, 12, 1, 2, 3] %}
        {% set is_shoulder = month in [4] %}
        {% set solar_excess = is_state('binary_sensor.solar_excess_available', 'on') %}

        {% if is_winter and temp < 18 and solar_excess %}
          heat_now
        {% elif is_summer and temp > 26 and solar_excess %}
          cool_now
        {% elif is_shoulder and temp < 19 and solar_excess %}
          heat_now
        {% elif is_shoulder and temp > 25 and solar_excess %}
          cool_now
        {% elif is_winter and temp < 16 %}
          heat_needed
        {% elif is_summer and temp > 28 %}
          cool_needed
        {% elif is_shoulder and temp < 17 %}
          heat_needed
        {% elif is_shoulder and temp > 27 %}
          cool_needed
        {% else %}
          comfortable
        {% endif %}
      icon: "mdi:thermometer"
      attributes:
        current_temp: "{{ states('sensor.study_esp32_ottosroom_temperature') }}"
        message: >
          {% set temp = states('sensor.study_esp32_ottosroom_temperature') | float(0) %}
          {% set state = states('sensor.ottos_room_climate_suggestion') %}
          {% if state == 'heat_now' %}
            ðŸ”¥ Good time to heat! Excess solar available and room is {{ temp }}Â°C
          {% elif state == 'cool_now' %}
            â„ï¸ Good time to cool! Excess solar available and room is {{ temp }}Â°C
          {% elif state == 'heat_needed' %}
            Room is cold ({{ temp }}Â°C) but no excess solar
          {% elif state == 'cool_needed' %}
            Room is warm ({{ temp }}Â°C) but no excess solar
          {% else %}
            Room temperature is comfortable ({{ temp }}Â°C)
          {% endif %}

- binary_sensor:
    # Appliance suggestions based on solar excess
    - name: "Dishwasher Suggestion"
      unique_id: dishwasher_suggestion
      state: >
        {% set solar_excess = is_state('binary_sensor.solar_excess_available', 'on') %}
        {% set dishwasher_on = is_state('input_boolean.dishwasher_on', 'on') %}
        {{ solar_excess and not dishwasher_on }}
      icon: "mdi:dishwasher"
      attributes:
        message: >
          {% if is_state('binary_sensor.dishwasher_suggestion', 'on') %}
            Good time to run dishwasher with excess solar power!
          {% else %}
            {% if is_state('input_boolean.dishwasher_on', 'on') %}
              Dishwasher already running
            {% else %}
              Waiting for excess solar power
            {% endif %}
          {% endif %}

    - name: "Dryer Suggestion"
      unique_id: dryer_suggestion
      state: >
        {% set solar_excess = is_state('binary_sensor.solar_excess_available', 'on') %}
        {% set dryer_on = is_state('input_boolean.dryer_on', 'on') %}
        {{ solar_excess and not dryer_on }}
      icon: "mdi:tumble-dryer"
      attributes:
        message: >
          {% if is_state('binary_sensor.dryer_suggestion', 'on') %}
            Good time to run dryer with excess solar power!
          {% else %}
            {% if is_state('input_boolean.dryer_on', 'on') %}
              Dryer already running
            {% else %}
              Waiting for excess solar power
            {% endif %}
          {% endif %}

    - name: "Washing Machine Suggestion"
      unique_id: washing_machine_suggestion
      state: >
        {% set solar_excess = is_state('binary_sensor.solar_excess_available', 'on') %}
        {% set washing_machine_on = is_state('input_boolean.washing_machine_on', 'on') %}
        {{ solar_excess and not washing_machine_on }}
      icon: "mdi:washing-machine"
      attributes:
        message: >
          {% if is_state('binary_sensor.washing_machine_suggestion', 'on') %}
            Good time to run washing machine with excess solar power!
          {% else %}
            {% if is_state('input_boolean.washing_machine_on', 'on') %}
              Washing machine already running
            {% else %}
              Waiting for excess solar power
            {% endif %}
          {% endif %}

- sensor:
    # Random appliance completion messages
    - name: "Washing Machine Random Message"
      unique_id: washing_machine_random_message
      state: >
        {% set messages = [
          "Washing is done! Henry, time to put the washing in the dryer (and maybe recruit Otto as your assistant)!",
          "Your clothes are squeaky clean! Don't leave them to get wrinkly!",
          "Ding ding! The washing machine has finished its spin class!",
          "Fresh and clean! Now don't forget them in there for three days...",
          "The washing machine says: I've done my job, now you do yours, Phil!",
          "Clean clothes ready! They won't fold themselves... unfortunately.",
          "Washing complete! Your socks have survived another round!",
          "The great wash is complete! Time to transfer before they get that smell.",
          "Your laundry adventure continues! Next stop: the dryer!",
          "Congratulations! You've unlocked Achievement: Clean Clothes. Now claim your reward!",
          "The washing machine is done showing off. Your turn to shine, Henryâ€”and maybe keep Otto and Lucas from diving into the basket.",
          "Breaking news: Clothes are clean! In other news, they need to be moved.",
          "Wash cycle complete! The clothes are having a pool party in there.",
          "Fresh laundry alert! Move fast before they develop their own ecosystem!",
          "The washing machine has spoken: Thy garments art cleansed!"
        ] %}
        {{ messages | random }}
      icon: "mdi:washing-machine"

    - name: "Dryer Random Message"
      unique_id: dryer_random_message
      state: >
        {% set messages = [
          "Dryer is done! Phil, please don't leave it there for ages again.",
          "Toasty warm clothes ready! While they're still warm would be nice...",
          "The dryer has completed its tumble routine! Don't let them wrinkle!",
          "Ding! Your clothes are now officially less wet than before!",
          "Dryer finished! Phil, time to reunite socks with their long-lost partners before Lucas adopts them.",
          "Hot and fresh! Like pizza, but laundry. And less delicious.",
          "The great tumble is over! Fold now or face the wrinkle monster!",
          "Dryer says: I gave you warm fluffy clothes, Steph. Fold them before Otto steals a sock and Lucas climbs inside.",
          "Congratulations! Your clothes have completed their spa treatment! Henry, tell Lucas to stop dragging them around.",
          "Breaking: Clothes are dry! Experts recommend actually putting them away this time, Phil.",
          "The dryer has finished its interpretive dance with your clothes! Otto reviewed it with five stars.",
          "Attention! Your previously wet items are now significantly less wet!",
          "Dryer complete! Warning: Clothes may still be capable of wrinkling.",
          "Fresh from the dryer! Get them while they're hot... literally!",
          "The circle of laundry continues! Now featuring: the folding chapter!"
        ] %}
        {{ messages | random }}
      icon: "mdi:tumble-dryer"

    - name: "Dishwasher Random Message"
      unique_id: dishwasher_random_message
      state: >
        {% set messages = [
          "Dishwasher done! Your dishes are cleaner than your browser history!",
          "Ding! The dish spa treatment is complete!",
          "Dishwasher finished! Now featuring: clean dishes that need putting away!",
          "Breaking news: Plates are clean! Still require manual relocation though.",
          "The great dish wash is complete! Empty me before I get sad.",
          "Dishwasher says: I cleaned them, you put them away. Deal?",
          "Your dishes have been sanitized! Unlike your phone screen...",
          "Wash cycle complete! Your forks are now fork-tastic!",
          "The dishwasher has finished its mission! Your turn to complete yours!",
          "Clean dishes ready! They're not going to put themselves away... yet.",
          "Attention: Dishes are sparkling! Act now while they're still impressive!",
          "Dishwasher complete! Achievement unlocked: Functional adult!",
          "Fresh clean dishes! Warning: May cause urge to actually cook something.",
          "The dish cleaning ceremony is complete! Now for the sacred unloading ritual!",
          "Congratulations! Your dishes no longer have things growing on them!"
        ] %}
        {{ messages | random }}
      icon: "mdi:dishwasher"




